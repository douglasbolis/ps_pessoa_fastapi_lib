name: Test, Deploy Lib and FastAPI Service

on:
  push:
    branches:
      - main
# fim_on

permissions:
  contents: read
  packages: write # NecessÃ¡rio para publicar no GitHub Packages
# fim_permissions

jobs:
  test-lib:
    name: ðŸ§ª Test PS Pessoas Lib
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lib locally (para testar)
        run: |
          # Instala a lib no modo editÃ¡vel/local para que os testes do 'make test-lib' funcionem
          python -m pip install .

      - name: Install build and test tools
        run: |
          make install-dev
      - name: Run tests for library
        run: |
          make test
    # fim_steps
  # fim_test-lib

  deploy-lib:
    name: ðŸ“¦ Publish Ps Pessoa Lib to GitHub Packages
    runs-on: ubuntu-latest
    needs: test-lib

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          make install-dev

      - name: Build library
        run: |
          make build-modern

      # - name: Publish library to GitHub Packages
      #   env:
      #     TWINE_USERNAME: ${{ github.actor }}
      #     TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      #     TWINE_VERIFY_SSL: false
      #   run: |
      #     python -m twine upload \
      #       --repository-url https://upload.pypi.pkg.github.com/${{ github.repository }} \
      #       dist/*
    # fim_steps
  # fim_deploy-lib

  test-service:
    name: ðŸ§ª Test FastAPI Service
    runs-on: ubuntu-latest
    needs: deploy-lib # Testar o serviÃ§o sÃ³ depois que a lib foi publicada

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install service dependencies
        run: |
          make install-dev
          make install-lib

      # - name: Install service dependencies
      #   run: |
      #     make install-dev
      #     make install-lib \
      #       --extra-index-url https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@pypi.pkg.github.com/${{ github.repository_owner }}/simple \
      #       --trusted-host pypi.pkg.github.com

      - name: Run tests for service
        run: |
          make test-app
    # fim_steps
  # fim_test-service

# fim_jobs
